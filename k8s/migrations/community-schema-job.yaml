apiVersion: batch/v1
kind: Job
metadata:
  name: community-db-setup
  namespace: comic-website
spec:
  template:
    spec:
      serviceAccountName: comic-backend-sa
      containers:
      - name: community-db-setup
        image: postgres:14-alpine
        command: ["/bin/sh"]
        args:
          - "-c"
          - |
            set -e
            echo "ğŸš€ Starting Community database setup..."
            
            # ç­‰å¾…æ•°æ®åº“å¯ç”¨
            echo "â³ Waiting for database to be available..."
            until pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME; do
              echo "Waiting for database connection..."
              sleep 2
            done
            
            # åˆ›å»º Community æ•°æ®åº“
            echo "ğŸ—ƒ Creating Community database..."
            PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
            CREATE DATABASE $COMMUNITY_DB;
            EOF
            
            # åˆ›å»º Community æ•°æ®åº“ç”¨æˆ·
            echo "ğŸ‘¤ Creating Community database user..."
            PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
            CREATE USER $COMMUNITY_USER WITH PASSWORD '$COMMUNITY_PASSWORD';
            GRANT ALL PRIVILEGES ON DATABASE $COMMUNITY_DB TO $COMMUNITY_USER;
            EOF
            
            echo "âœ… Community database setup completed successfully!"
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: rds-secret
              key: host
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          value: "comicadmin"
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: rds-secret
              key: password
        - name: DB_NAME
          value: "comicdb"
        - name: COMMUNITY_DB
          value: "communitydb"
        - name: COMMUNITY_USER
          value: "community_user"
        - name: COMMUNITY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: community-db-password
        resources:
          limits:
            cpu: "500m"
            memory: "512Mi"
          requests:
            cpu: "200m"
            memory: "256Mi"
      restartPolicy: OnFailure
  backoffLimit: 2
  activeDeadlineSeconds: 300
---
apiVersion: batch/v1
kind: Job
metadata:
  name: community-schema-setup
  namespace: comic-website
spec:
  template:
    spec:
      serviceAccountName: comic-backend-sa
      containers:
      - name: community-schema-setup
        image: postgres:14-alpine
        command: ["/bin/sh"]
        args:
          - "-c"
          - |
            set -e
            echo "ğŸš€ Setting up Community database schema..."
            
            # ç­‰å¾…æ•°æ®åº“å¯ç”¨
            echo "â³ Waiting for Community database to be available..."
            until pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME; do
              echo "Waiting for database connection..."
              sleep 2
            done
            
            # æ‰§è¡Œ SQL è¿ç§»æ–‡ä»¶
            echo "ğŸ“¦ Running community database migrations..."
            
            # åˆ›å»ºåŸºæœ¬çš„ç¤¾åŒºè¡¨ç»“æ„
            PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
            -- åˆ›å»ºå¸–å­è¡¨
            CREATE TABLE IF NOT EXISTS posts (
              id SERIAL PRIMARY KEY,
              title VARCHAR(255) NOT NULL,
              content TEXT,
              author_id INTEGER,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            
            -- åˆ›å»ºè¯„è®ºè¡¨
            CREATE TABLE IF NOT EXISTS comments (
              id SERIAL PRIMARY KEY,
              post_id INTEGER REFERENCES posts(id),
              content TEXT,
              author_id INTEGER,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            
            -- ä¸ºç¤¾åŒºç”¨æˆ·æˆäºˆæƒé™
            GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $DB_USER;
            GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $DB_USER;
            EOF
            
            echo "âœ… Community schema setup completed successfully!"
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: rds-secret
              key: host
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          value: "community_user"
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: community-db-password
        - name: DB_NAME
          value: "communitydb"
        resources:
          limits:
            cpu: "500m"
            memory: "512Mi"
          requests:
            cpu: "200m"
            memory: "256Mi"
      restartPolicy: OnFailure
  backoffLimit: 2
  activeDeadlineSeconds: 300