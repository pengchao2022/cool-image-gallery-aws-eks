const express = require('express');
const router = express.Router();

// ä¸´æ—¶å†…å­˜å­˜å‚¨
let discussions = [];
let nextId = 1;

// ç®€åŒ–çš„è®¤è¯ä¸­é—´ä»¶
const auth = (req, res, next) => {
  // ä¸´æ—¶è®¤è¯ - æ€»æ˜¯é€šè¿‡
  req.user = {
    userId: 'user123',
    username: 'Test User'
  };
  console.log('ğŸ” Auth middleware executed');
  next();
};

// ç®€åŒ–çš„éªŒè¯ä¸­é—´ä»¶
const validation = {
  createDiscussion: (req, res, next) => {
    const { title, content } = req.body;
    
    if (!title || title.trim().length === 0) {
      return res.status(400).json({
        success: false,
        message: 'Title is required'
      });
    }
    
    if (!content || content.trim().length === 0) {
      return res.status(400).json({
        success: false,
        message: 'Content is required'
      });
    }
    
    console.log('âœ… Validation passed');
    next();
  }
};

// ç®€åŒ–çš„æ§åˆ¶å™¨
const discussionController = {
  getDiscussions: async (req, res) => {
    try {
      const { page = 1, limit = 20, sort = '-createdAt', search } = req.query;
      
      console.log('ğŸ“ Get discussions called with:', { page, limit, search });
      
      let filteredDiscussions = [...discussions];
      
      // æœç´¢è¿‡æ»¤
      if (search) {
        filteredDiscussions = filteredDiscussions.filter(d => 
          d.title.toLowerCase().includes(search.toLowerCase()) || 
          d.content.toLowerCase().includes(search.toLowerCase())
        );
      }
      
      // æ’åº
      if (sort === '-createdAt') {
        filteredDiscussions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }
      
      // åˆ†é¡µ
      const startIndex = (page - 1) * limit;
      const endIndex = startIndex + parseInt(limit);
      const paginatedDiscussions = filteredDiscussions.slice(startIndex, endIndex);
      
      res.json({
        success: true,
        discussions: paginatedDiscussions,
        pagination: {
          page: parseInt(page),
          limit: parseInt(limit),
          total: filteredDiscussions.length,
          pages: Math.ceil(filteredDiscussions.length / limit)
        }
      });
    } catch (error) {
      console.error('âŒ Error in getDiscussions:', error);
      res.status(500).json({ 
        success: false, 
        message: 'Internal server error' 
      });
    }
  },

  getDiscussion: async (req, res) => {
    try {
      const { id } = req.params;
      console.log('ğŸ“ Get discussion called with ID:', id);
      
      const discussion = discussions.find(d => d.id == id);
      
      if (!discussion) {
        return res.status(404).json({ 
          success: false, 
          message: 'Discussion not found' 
        });
      }

      // å¢åŠ æµè§ˆé‡
      discussion.viewCount = (discussion.viewCount || 0) + 1;
      console.log(`ğŸ‘€ Discussion ${id} view count: ${discussion.viewCount}`);
      
      // æ¨¡æ‹Ÿè·å–å›å¤
      const replies = [];

      res.json({
        success: true,
        discussion,
        replies
      });
    } catch (error) {
      console.error('âŒ Error in getDiscussion:', error);
      res.status(500).json({ 
        success: false, 
        message: 'Internal server error' 
      });
    }
  },

  createDiscussion: async (req, res) => {
    try {
      const { title, content, tags } = req.body;
      
      console.log('ğŸ“ Create discussion called with:', { title, content, tags });

      const newDiscussion = {
        id: nextId++,
        title,
        content,
        author: req.user.userId,
        authorName: req.user.username,
        tags: tags || [],
        viewCount: 0,
        createdAt: new Date(),
        updatedAt: new Date()
      };

      discussions.push(newDiscussion);
      
      console.log('âœ… Discussion created:', newDiscussion.id);

      // æ¨¡æ‹Ÿç”¨æˆ·æ´»åŠ¨è®°å½•
      console.log('ğŸ“Š User activity recorded for discussion creation');

      res.status(201).json({
        success: true,
        message: 'Discussion created successfully',
        discussion: newDiscussion
      });
    } catch (error) {
      console.error('âŒ Error in createDiscussion:', error);
      res.status(500).json({ 
        success: false, 
        message: 'Internal server error' 
      });
    }
  }
};

// è·¯ç”±å®šä¹‰
router.get('/', discussionController.getDiscussions);
router.get('/:id', discussionController.getDiscussion);
router.post('/', auth, validation.createDiscussion, discussionController.createDiscussion);

// æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
if (process.env.NODE_ENV === 'development') {
  discussions = [
    {
      id: 1,
      title: 'Welcome to Community!',
      content: 'This is the first discussion in our community. Feel free to introduce yourself!',
      author: 'system',
      authorName: 'System',
      tags: ['welcome', 'introduction'],
      viewCount: 15,
      createdAt: new Date('2024-01-01'),
      updatedAt: new Date('2024-01-01')
    },
    {
      id: 2,
      title: 'Best Comic Books of 2024',
      content: 'What are your favorite comic books released this year?',
      author: 'user123',
      authorName: 'Comic Fan',
      tags: ['comics', '2024', 'recommendations'],
      viewCount: 8,
      createdAt: new Date('2024-01-02'),
      updatedAt: new Date('2024-01-02')
    }
  ];
  nextId = 3;
  console.log('ğŸ“š Loaded example discussions');
}

console.log('âœ… Discussion routes loaded successfully');

module.exports = router;